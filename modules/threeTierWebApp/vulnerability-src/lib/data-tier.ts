import cdk = require('@aws-cdk/core');
import ec2 = require('@aws-cdk/aws-ec2');
import rds = require('@aws-cdk/aws-rds');
import { SrcStackVulnerabilityOptions } from './src-stack';
import { RemovalPolicy } from '@aws-cdk/core';

export interface DataTierConstructProps {
  vpc?: ec2.Vpc,
  vulnerabilityOptions?: SrcStackVulnerabilityOptions
}

export class DataTierConstruct extends cdk.Construct {
  /** @returns the ID of the VPC */
  public readonly vpcId: string;

  constructor(scope: cdk.Construct, id: string, props: DataTierConstructProps = {}) {
    super(scope, id);

    const vpc = props.vpc || new ec2.Vpc(this, 'VPC');

    // public security groups!
    const sg = new ec2.SecurityGroup(this, 'openDbSg', {
      allowAllOutbound: true,
      description: 'My Db is open to the world',
      securityGroupName: 'sgDbOpenToTheWorld',
      vpc
    });
    sg.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.allTraffic());
    sg.addIngressRule(ec2.Peer.anyIpv6(), ec2.Port.allTraffic());

    const serverlessCluster = new rds.CfnDBCluster(this, 'MyDb', {
      dbClusterIdentifier: 'mydbid'+vpc.vpcId,
      databaseName: 'masterdb',
      engine: 'aurora',
      engineMode: 'serverless',
      engineVersion: '5.6.10a',
      masterUsername: 'dbuser',
      masterUserPassword: 'dbpassword',
      dbSubnetGroupName: new rds.CfnDBSubnetGroup(this, "db-subnet-group", {
        dbSubnetGroupDescription: `database cluster subnet group`,
        subnetIds: vpc.selectSubnets().subnetIds
      }).ref,
      scalingConfiguration: {
        minCapacity: 8
      },
      vpcSecurityGroupIds: [sg.securityGroupId]
    });

    // dbCluster.connections.addSecurityGroup(sg);
    this.vpcId = vpc.vpcId;
    
  }
}